name: Daily Supabase Backup

on:
  schedule:
    - cron: '0 0 * * *'          # 每天 UTC 00:00 执行（可改成你想要的时间）
  workflow_dispatch:             # 允许手动触发

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write              # 必须有写权限才能 commit

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Supabase Backup
        uses: mansueli/supa-backup@v1.0.5
        with:
          supabase_url: ${{ secrets.SUPABASE_DB_URL }}   # postgresql://postgres.[project-ref]:[your-password]@db.[project-ref].supabase.co:6543/postgres
          file_prefix: 'backup-'                         # 可选，文件名前缀
          pg_dump_args: '--exclude-schema=auth --exclude-schema=storage --exclude-schema=supabase_functions'  # 可选，排除系统 schema

      - name: Commit backup
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: daily supabase backup $(date +'%Y-%m-%d')"
          file_pattern: '*.sql *.dump'   # 根据你生成的备份文件后缀
